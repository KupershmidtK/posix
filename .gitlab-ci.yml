stages:
  - build
  - builtin-test
  - tidy
  - test

build:
  stage: build
  script:
    - bash build
    - mv -- results "$GIT_CLONE_PATH"
  artifacts:
    when: always
    reports:
      junit: results/TEST-build.xml

builtin_tests:
  stage: builtin-test
  needs: ["build"]
  script:
    - cd -- "$GIT_CLONE_PATH"
    - CXX=clang++ make build_tests  
    - make run_tests | doctest-junit-report > report.xml
  artifacts:
    when: always
    reports:
      junit: report.xml

tidy:
  stage: tidy
  needs: ["build"]
  script:
    - cd -- "$GIT_CLONE_PATH"
    - make clang_format
    - make clang_tidy

tests:
  stage: test
  needs: ["build", "tidy"]
  script:
    - bash tests
    - mv -- results "$GIT_CLONE_PATH"
  artifacts:
    when: always
    reports:
      junit: results/TEST-build.xml
